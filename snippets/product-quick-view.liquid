{%- liquid
  assign product_form_id = 'quick-view-form-' | append: product.id
-%}

<div class="quick-view__container">
  <!-- Gallery -->
  <div class="quick-view__gallery">
    <div id="quickview-splide-{{ product.id }}" class="splide quickview-splide">
      {% if product.compare_at_price > product.price %}
        {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
        <span class="discount-badge">-{{ discount | round }}%</span>
      {% endif %}
      <div class="splide__track">
        <ul class="splide__list">
          {% if product.media.size > 0 %}
            {% for media in product.media %}
              {% if media.media_type == 'image' %}
                <li class="splide__slide">
                  <img 
                    src="{{ media | img_url: '600x' }}" 
                    alt="{{ media.alt | escape }}" 
                    loading="lazy"
                  >
                </li>
              {% endif %}
            {% endfor %}
          {% else %}
            <li class="splide__slide">
              <img 
                src="{{ 'placeholder.png' | asset_url }}" 
                alt="Placeholder"
              >
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Product Info -->
  <div class="quick-view__info">
    {%- form 'product', product, id: product_form_id, class: 'product-form', data-product-form: '' -%}
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

      <safe-sticky class="product-info">
        <div class="product-info__block-list">

          <!-- Title -->
          <div class="product-info__block-item" data-block-type="title">
            <h2 class="product-title">
              <a href="{{ product.url }}">{{ product.title }}</a>
            </h2>
          </div>

          <!-- Price -->
          <div class="product-info__block-item pricing" data-block-type="price">
            <span>from</span>
            <p class="static-price">{{ product.selected_or_first_available_variant.price | money }}</p>
          </div>

          <!-- Description -->
          <div class="product-info__block-item" data-block-type="description">
            <p class="product-description">
              {{ product.description | strip_html | truncate: 203 }}
            </p>
          </div>

          <!-- Custom Variant Picker -->
          {% if product.has_only_default_variant == false %}
          <div class="product-info__block-item custom-variant-picker" data-block-type="variant-picker">
            {% for option in product.options_with_values %}
              <div class="variant-option" data-option-index="{{ forloop.index0 }}">
                <label>{{ option.name }}: <span class="selected-value">{{ option.values.first }}</span></label>
                <select class="variant-select" data-option-index="{{ forloop.index0 }}">
                  {% for value in option.values %}
                    <option value="{{ value }}">{{ value }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endfor %}
          </div>
          {% endif %}

          <!-- Price + Compare Price -->
          <div class="product-info__block-item pricing" data-block-type="price">
            <span class="price-wrapper">
              {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
                <span class="compare-price">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
              {% endif %}
              <span class="price">{{ product.selected_or_first_available_variant.price | money }}</span>
            </span>
          </div>

          <!-- Quantity Selector -->
          {% if product.available %}
            <div class="product-info__block-item" data-block-type="quantity-selector">
              <div class="v-stack gap-1 justify-items-start">
                {%- liquid
                  assign variant = product.selected_or_first_available_variant
                  render 'quantity-selector', variant: variant, form: product_form_id
                -%}
              </div>
            </div>
          {% endif %}

          <!-- Buy Buttons -->
          <div class="product-info__block-item" data-block-type="buy-buttons">
            <div class="product-form" data-product-form>
              {%- render 'buy-buttons',
                  product: product,
                  form_id: product_form_id,
                  show_payment_button: true,
                  show_gift_card_recipient: true
              -%}
            </div>
          </div>

        </div>
      </safe-sticky>
    {%- endform -%}
  </div>
</div>

<!-- Prepare variants array -->
<script>
  window['variants_{{ product.id }}'] = [
    {% for variant in product.variants %}
      {
        id: {{ variant.id }},
        options: {{ variant.options | json }},
        price_formatted: "{{ variant.price | money }}",
        compare_at_price_formatted: "{{ variant.compare_at_price | money }}",
        compare_at_price: {{ variant.compare_at_price | default: 0 }},
        price: {{ variant.price }},
        available: {{ variant.available | json }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
</script>

<script>
  // Auto-initialize for non-modal usage (if needed)
  document.addEventListener('DOMContentLoaded', function() {
    const quickViewContainer = document.querySelector('.quick-view__container');
    if (quickViewContainer && !document.querySelector('#quickview-modal')) {
      // Only auto-init if not in a modal context
      initQuickView('{{ product.id }}', '{{ product_form_id }}');
    }
  });
</script>

<style>
  .custom-variant-picker .variant-option {
    margin-bottom: 1rem;
  }

  .custom-variant-picker label {
    font-weight: 500;
    display: block;
    margin-bottom: 0.25rem;
  }

  .custom-variant-picker .selected-value {
    font-weight: bold;
    margin-left: 5px;
  }

  .compare-price {
  text-decoration: line-through;
  color: #999;
  margin-left: 8px;
  font-size: 0.9em;
}

.price-wrapper .price {
  color: #ec0101;
}

</style>
